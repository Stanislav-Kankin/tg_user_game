<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Game</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        const defaultUrl = "https://2be7-147-45-193-130.ngrok-free.app"; // TUNNEL!!

        document.addEventListener('DOMContentLoaded', () => {
            // Получение элементов DOM
            const rocket = document.getElementById('rocket');
            const asteroids = Array.from({ length: 4 }, (_, i) => document.getElementById(`asteroid${i + 1}`));
            const gameContainer = document.getElementById('game-container');
            const scoreDisplay = document.getElementById('score');
            const levelDisplay = document.getElementById('level');
            const background = document.getElementById('background');
            const background2 = document.getElementById('background2');
            const gameOverSound = document.getElementById('game-over-sound');
            const boomSound = document.getElementById('boom-sound');

            // Инициализация переменных
            let score = 0;
            let level = 1;
            let gameOver = false;

            let isDragging = false;
            let offsetX, offsetY;

            // Обработка событий мыши для перемещения ракеты
            rocket.addEventListener('mousedown', (e) => {
                isDragging = true;
                const gameContainerRect = gameContainer.getBoundingClientRect();
                offsetX = e.clientX - rocket.getBoundingClientRect().left + gameContainerRect.left;
                offsetY = e.clientY - rocket.getBoundingClientRect().top + gameContainerRect.top;
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    let x = e.clientX - offsetX;
                    let y = e.clientY - offsetY;
                    rocket.style.left = `${x}px`;
                    rocket.style.top = `${y}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Обработка событий тач для перемещения ракеты
            rocket.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                const gameContainerRect = gameContainer.getBoundingClientRect();
                offsetX = touch.clientX - rocket.getBoundingClientRect().left + gameContainerRect.left;
                offsetY = touch.clientY - rocket.getBoundingClientRect().top + gameContainerRect.top;
            });

            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    let x = touch.clientX - offsetX;
                    let y = touch.clientY - offsetY;
                    rocket.style.left = `${x}px`;
                    rocket.style.top = `${y}px`;
                }
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });

            // Функция для движения астероидов
            function moveAsteroid(asteroid, delay) {
                if (gameOver) return;
                asteroid.style.top = '-50px';
                asteroid.style.left = `${Math.random() * (gameContainer.clientWidth - 50)}px`;
                asteroid.style.transition = `top ${delay}s linear`;
                asteroid.style.top = `${gameContainer.clientHeight}px`;

                setTimeout(() => {
                    asteroid.style.transition = 'none';
                    asteroid.style.display = 'block';
                    asteroid.scored = false;
                    moveAsteroid(asteroid, delay);
                }, delay * 1000);
            }

            // Функция для проверки столкновений
            function checkCollision() {
                if (gameOver) return;
                const rocketRect = rocket.getBoundingClientRect();
                const rocketCenterX = rocketRect.left + rocketRect.width / 2;
                const rocketCenterY = rocketRect.top + rocketRect.height / 2;

                const collisionRadius = 28; // Радиус столкновения

                asteroids.forEach(asteroid => {
                    const asteroidRect = asteroid.getBoundingClientRect();
                    const asteroidCenterX = asteroidRect.left + asteroidRect.width / 2;
                    const asteroidCenterY = asteroidRect.top + asteroidRect.height / 2;

                    const distance = Math.sqrt(
                        Math.pow(rocketCenterX - asteroidCenterX, 2) +
                        Math.pow(rocketCenterY - asteroidCenterY, 2)
                    );

                    if (distance < collisionRadius) {
                        asteroid.style.display = 'none';
                        showBoom(asteroidRect.left, asteroidRect.top);
                        showMessage(asteroidRect.left, asteroidRect.top, '-50', 'red');
                        score -= 50;
                        boomSound.play(); // Воспроизведение звука столкновения

                        // Сразу же перемещаем астероид в начальное положение и запускаем его движение заново
                        asteroid.style.top = '-50px';
                        asteroid.style.left = `${Math.random() * (gameContainer.clientWidth - 50)}px`;
                        asteroid.style.transition = `top ${asteroid.delay}s linear`;
                        asteroid.style.top = `${gameContainer.clientHeight}px`;
                        asteroid.style.display = 'block';
                        asteroid.scored = false;
                    } else if (asteroidRect.bottom >= gameContainer.clientHeight && !asteroid.scored) {
                        showMessage(asteroidRect.left, asteroidRect.top, '+5', 'green');
                        score += 5;
                        asteroid.scored = true;
                        asteroid.style.display = 'none'; // Скрываем астероид
                    }
                });

                scoreDisplay.innerText = `Score: ${score}`;
                levelDisplay.innerText = `Level: ${level}`;

                if (score < 0) {
                    gameOver = true;
                    rocket.src = '../static/images/explosion.gif'; // Замените на путь к вашему изображению взрыва
                    gameOverSound.play(); // Воспроизведение звука проигрыша
                    setTimeout(() => {
                        const gameOverMessage = document.createElement('div');
                        gameOverMessage.style.position = 'absolute';
                        gameOverMessage.style.top = '40%';
                        gameOverMessage.style.left = '50%';
                        gameOverMessage.style.transform = 'translate(-50%, -50%)';
                        gameOverMessage.style.fontSize = '30px';
                        gameOverMessage.style.color = 'white';
                        gameOverMessage.style.textAlign = 'center';
                        gameOverMessage.innerHTML = '<img src="../static/images/game-over.png" alt="Game Over" style="width: 100px; height: 100px;"><br>Game Over!';
                        gameContainer.appendChild(gameOverMessage);
                    }, 1000);
                }

                if (score >= 100 * level) {
                    level++;
                    updateAsteroids();
                }
            }

            // Функция для обновления астероидов в зависимости от уровня
            function updateAsteroids() {
                const delays = [10, 9, 8, 7];
                asteroids.forEach((asteroid, index) => {
                    asteroid.delay = Math.max(delays[index] - level + 1, 2);
                    asteroid.style.display = 'block';
                    moveAsteroid(asteroid, asteroid.delay);
                });
            }

            // Функция для отображения сообщений
            function showMessage(left, top, text, color) {
                const message = document.createElement('div');
                message.className = 'message';
                message.style.left = `${left}px`;
                message.style.top = `${top}px`;
                message.style.color = color;
                message.innerText = text;
                gameContainer.appendChild(message);

                setTimeout(() => {
                    message.style.opacity = '0';
                }, 1000);

                setTimeout(() => {
                    gameContainer.removeChild(message);
                }, 2000);
            }

            // Функция для отображения взрыва
            function showBoom(left, top) {
                const boom = document.createElement('img');
                boom.src = '../static/images/boom.gif';
                boom.style.position = 'absolute';
                boom.style.left = `${left}px`;
                boom.style.top = `${top}px`;
                boom.style.width = '50px';
                boom.style.height = '50px';
                gameContainer.appendChild(boom);

                setTimeout(() => {
                    gameContainer.removeChild(boom);
                }, 1000);
            }

            // Функция для движения фона
            function moveBackground() {
                let position = 0;
                setInterval(() => {
                    position += 1; // Измените значение на положительное для движения вниз
                    background.style.transform = `translateY(${position}px)`;
                    background2.style.transform = `translateY(${position - gameContainer.clientHeight}px)`;

                    if (position >= gameContainer.clientHeight) {
                        position = 0;
                    }
                }, 21); // Увеличьте значение для более медленного движения
            }

            // Запуск игры
            setInterval(checkCollision, 100);

            updateAsteroids();

            moveBackground();
        });
    </script>
</head>
<body>
    <div id="game-container">
        <div id="background"></div>
        <div id="background2"></div>
        <div id="score" style="position: absolute; top: 10px; left: 10px; font-size: 20px; color: white;">Score: 0</div>
        <div id="level" style="position: absolute; top: 10px; right: 10px; font-size: 20px; color: white;">Level: 1</div>
        <img id="rocket" src="../static/images/rocket.gif" alt="Rocket">
        <img id="asteroid1" src="../static/images/aster1.png" alt="Asteroid 1" class="asteroid">
        <img id="asteroid2" src="../static/images/aster2.png" alt="Asteroid 2" class="asteroid">
        <img id="asteroid3" src="../static/images/aster3.png" alt="Asteroid 3" class="asteroid">
        <img id="asteroid4" src="../static/images/aster4.png" alt="Asteroid 4" class="asteroid">
        <audio id="game-over-sound" src="../static/sound/av.mp3"></audio>
        <audio id="boom-sound" src="../static/sound/boom1.mp3"></audio>
    </div>
</body>
</html>
